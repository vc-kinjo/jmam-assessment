FROM node:18

WORKDIR /app

# Set environment variables to prevent network issues and warnings
ENV NEXT_TELEMETRY_DISABLED=1
ENV NPM_CONFIG_AUDIT=false
ENV NPM_CONFIG_FUND=false
ENV NPM_CONFIG_UPDATE_NOTIFIER=false
ENV SKIP_SWC_BINARY_DOWNLOAD=1
# Prevent fetch issues in Docker
ENV NODE_TLS_REJECT_UNAUTHORIZED=0
ENV CYPRESS_INSTALL_BINARY=0
# Fix for lockfile patching issues
ENV NPM_CONFIG_REGISTRY=https://registry.npmjs.org/
ENV NODE_OPTIONS="--max-old-space-size=4096"
# Disable SWC patching completely
ENV NEXT_PRIVATE_SKIP_SWC_PATCH=1
ENV SWCRC=false

# Copy package files and lockfile
COPY package*.json ./

# Clear npm cache and install dependencies fresh
RUN npm cache clean --force
RUN npm install --verbose

# Copy source code
COPY . .

# Clean up potential issues
RUN rm -rf .next 2>/dev/null || true
RUN rm -rf node_modules/.cache 2>/dev/null || true

# Expose port
EXPOSE 3000

# Health check using wget since curl is not installed
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1

# Start development server with polling for file changes in Docker
CMD ["npm", "run", "dev:docker"]